<?xml version="1.0" encoding="UTF-8"?>  

<databaseChangeLog  
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"  
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"  
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.2.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <property  name="pwd.auditor"  value="auditor"/>

    <changeSet author="registry owner" id="extension uuid-ossp">
        <comment>Extension to generate uuid values</comment>
        <sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
            CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
        </sql>
        <rollback>
            <sql splitStatements="true" stripComments="true">
                DROP EXTENSION "uuid-ossp";
            </sql>
        </rollback>
    </changeSet>

    <changeSet author="registry owner" id="table audit_event">
        <comment>CREATE TABLE audit_event</comment>
        <createTable tableName="audit_event">
            <column name="id" type="BIGSERIAL">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_id"/>
            </column>
            <column name="request_id" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="application" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="TEXT">
            </column>
            <column name="user_name" type="TEXT">
            </column>
            <column name="source_system" type="TEXT">
            </column>
            <column name="source_business_id" type="TEXT">
            </column>
            <column name="source_business_process" type="TEXT">
            </column>
            <column name="context" type="TEXT">
             </column>
            <column name="received" defaultValueComputed="CURRENT_TIMESTAMP" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="registry owner" id="view audit_event_user_action_v">
        <comment>View audit_event_user_action_v</comment>
        <sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
            CREATE VIEW audit_event_user_action_v AS
            SELECT
                id
                ,request_id
                ,application
                ,name
                ,"type"
                ,"timestamp"
                ,user_id
                ,user_name
                ,source_business_id
                ,source_business_process
                ,source_system
                ,(context::jsonb)->>'action' as "action"
                ,(context::jsonb)->>'step' as step
                ,(context::jsonb)->>'tablename' as tablename
                ,(context::jsonb)->>'row_id' as row_id
                ,((context::jsonb)->>'fields') as fields
                ,context::jsonb as cntx
            FROM audit_event
            WHERE type = 'USER_ACTION';
        </sql>
        <rollback>
            <sql splitStatements="true" stripComments="true">DROP VIEW audit_event_user_action_v;</sql>
        </rollback>
    </changeSet>

    <changeSet author="registry owner" id="view audit_event_security_event_v">
        <comment>View audit_event_security_event_v</comment>
        <sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
            CREATE VIEW audit_event_security_event_v AS
            SELECT
                id
                ,request_id
                ,application
                ,name
                ,"type"
                ,"timestamp"
                ,user_id
                ,user_name
                ,source_business_id
                ,source_business_process
                ,source_system
                ,(context::jsonb)->>'action' as "action"
                ,context::jsonb as cntx
            FROM audit_event
            WHERE type = 'SECURITY_EVENT';
        </sql>
        <rollback>
            <sql splitStatements="true" stripComments="true">
                DROP VIEW audit_event_security_event_v;
            </sql>
        </rollback>
    </changeSet>

    <changeSet author="registry owner" id="reset audit user" runInTransaction="false">
        <sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
            GRANT SELECT ON audit_event_user_action_v TO analytics_auditor;
            GRANT SELECT ON audit_event_security_event_v TO analytics_auditor;
        </sql>
        <rollback>
            <empty/>
        </rollback>
    </changeSet>

    <changeSet author="registry owner" id="grant on audit_event" runInTransaction="false">
        <sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
            GRANT INSERT ON audit_event TO audit_service_user;
        </sql>
        <rollback>
            <empty/>
        </rollback>
    </changeSet>

    <changeSet author="registry owner" id="restore audit.xml">
        <empty/>
    </changeSet>

</databaseChangeLog>
