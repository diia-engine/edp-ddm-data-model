<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.2.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext xsd/dbchangelog-ext.xsd">

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2272">
        <comment>CREATE search condition laboratory_start_with_edrpou_contains_name</comment>
        <ext:createSearchCondition name="laboratory_start_with_edrpou_contains_name" limit="100">
            <ext:table name="laboratory" alias="l">
                <ext:column name="laboratory_id" returning="true"/>
                <ext:column name="edrpou" searchType="startsWith" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2273">
        <comment>CREATE search condition laboratory_equal_edrpou_name_count</comment>
        <ext:createSearchCondition name="laboratory_equal_edrpou_name_count">
            <ext:table name="laboratory">
                <ext:function name="count" alias="cnt" columnName="laboratory_id"/>
                <ext:column name="edrpou" searchType="equal" returning="true"/>
                <ext:column name="name" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2274">
        <comment>CREATE search condition koatuu_obl_contains_name</comment>
        <ext:createSearchCondition name="koatuu_obl_contains_name">
            <ext:table name="koatuu" alias="k">
                <ext:column name="koatuu_id" returning="true"/>
                <ext:column name="code" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="k" columnName="type" operator="eq" value="'О'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2275">
        <comment>CREATE search condition koatuu_np_starts_with_name_by_obl</comment>
        <ext:createSearchCondition name="koatuu_np_starts_with_name_by_obl" limit="100">
            <ext:table name="koatuu" alias="np">
                <ext:column name="koatuu_id" returning="true"/>
                <ext:column name="name" searchType="startsWith" sorting="asc" returning="true"/>
                <ext:column name="level1" searchType="equal" returning="true"/>
            </ext:table>
            <ext:table name="koatuu" alias="rn">
                <ext:column name="name" alias="name_rn" returning="true"/>
            </ext:table>
            <ext:join type="left">
                <ext:left alias="np">
                    <ext:column name="level2"/>
                </ext:left>
                <ext:right alias="rn">
                    <ext:column name="code"/>
                </ext:right>
                <ext:condition logicOperator="and" tableAlias="rn" columnName="type" operator="eq" value="'Р'"/>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="np" columnName="type" operator="eq" value="'НП'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2276">
        <comment>CREATE search condition ownership_contains_name</comment>
        <ext:createSearchCondition name="ownership_contains_name">
            <ext:table name="ownership" alias="o">
                <ext:column name="ownership_id" returning="true"/>
                <ext:column name="code" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2277">
        <comment>CREATE search condition kopfg_contains_name</comment>
        <ext:createSearchCondition name="kopfg_contains_name">
            <ext:table name="kopfg" alias="k">
                <ext:column name="kopfg_id" returning="true"/>
                <ext:column name="code" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2278">
        <comment>CREATE search condition factor_physical_contains_name</comment>
        <ext:createSearchCondition name="factor_physical_contains_name">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Фізичний'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2279">
        <comment>CREATE search condition factor_labour_contains_name</comment>
        <ext:createSearchCondition name="factor_labour_contains_name">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Трудового процесу'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2280">
        <comment>CREATE search condition factor_bio_contains_name</comment>
        <ext:createSearchCondition name="factor_bio_contains_name">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Біологічний'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2281">
        <comment>CREATE search condition factor_chemical_host_contains_name</comment>
        <ext:createSearchCondition name="factor_chemical_host_contains_name" limit="100">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Хімічний: ГОСТ'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2283">
        <comment>CREATE search condition factor_chemical_hygiene_contains_name</comment>
        <ext:createSearchCondition name="factor_chemical_hygiene_contains_name" limit="100">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Хімічний: Гігієнічні регламенти'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2285">
        <comment>CREATE search condition factor_chemical_obrb_contains_name</comment>
        <ext:createSearchCondition name="factor_chemical_obrb_contains_name" limit="100">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Хімічний: ОБРВ'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2286">
        <comment>CREATE search condition solution_type_equal_constant_code</comment>
        <ext:createSearchCondition name="solution_type_equal_constant_code">
            <ext:table name="solution_type" alias="f">
                <ext:column name="solution_type_id" returning="true"/>
                <ext:column name="name" returning="true"/>
                <ext:column name="constant_code" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2290">
        <comment>CREATE search condition refusal_reason_equal_constant_code_contains_name</comment>
        <ext:createSearchCondition name="refusal_reason_equal_constant_code_contains_name">
            <ext:table name="refusal_reason" alias="r">
                <ext:column name="refusal_reason_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
                <ext:column name="constant_code" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2296">
        <comment>CREATE search condition research_contains_name</comment>
        <ext:createSearchCondition name="research_contains_name">
            <ext:table name="research" alias="r">
                <ext:column name="research_id" returning="true"/>
                <ext:column name="research_type" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2297">
        <comment>CREATE search condition factor_chemical_arbitrary_contains_name</comment>
        <ext:createSearchCondition name="factor_chemical_arbitrary_contains_name" limit="100">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="code" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Хімічний: довільні'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2301">
        <comment>CREATE search condition staff_equal_laboratory_id_contains_full_name</comment>
        <ext:createSearchCondition name="staff_equal_laboratory_id_contains_full_name">
            <ext:table name="staff" alias="s">
                <ext:column name="staff_id" returning="true"/>
                <ext:column name="laboratory_id" searchType="equal" returning="true"/>
                <ext:column name="full_name" sorting="asc" searchType="contains" returning="true"/>
                <ext:column name="hygienist_flag" returning="true"/>
                <ext:column name="specialization_date" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2302,4017">
        <comment>CREATE search condition staff_contains_name</comment>
        <ext:createSearchCondition name="staff_contains_name">
            <ext:table name="staff_status" alias="s">
                <ext:column name="staff_status_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
                <ext:column name="constant_code" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-4016">
        <comment>CREATE search condition staff_equal_constant_code</comment>
        <ext:createSearchCondition name="staff_equal_constant_code">
            <ext:table name="staff_status" alias="s">
                <ext:column name="staff_status_id" returning="true"/>
                <ext:column name="name" returning="true"/>
                <ext:column name="constant_code" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2441">
        <comment>CREATE search condition staff_equal_laboratory_id_count</comment>
        <ext:createSearchCondition name="staff_equal_laboratory_id_count">
            <ext:table name="staff">
                <ext:function name="count" alias="cnt" columnName="staff_id"/>
                <ext:column name="laboratory_id" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2558">
        <comment>CREATE search condition factor_equal_factor_type_name_count</comment>
        <ext:createSearchCondition name="factor_equal_factor_type_name_count">
            <ext:table name="factor" alias="f">
                <ext:function name="count" alias="cnt" columnName="factor_id"/>
                <ext:column name="name" searchType="equal" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Хімічний: довільні'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-2702">
        <comment>CREATE search condition koatuu_equal_koatuu_id_name</comment>
        <ext:createSearchCondition name="koatuu_equal_koatuu_id_name" limit="100">
            <ext:table name="koatuu" alias="np">
                <ext:column name="koatuu_id" searchType="equal" returning="true"/>
                <ext:column name="name" returning="true"/>
            </ext:table>
            <ext:table name="koatuu" alias="o">
                <ext:column name="koatuu_id" alias="koatuu_id_obl" returning="true"/>
                <ext:column name="name" alias="name_obl" returning="true"/>
            </ext:table>
            <ext:join type="left">
                <ext:left alias="np">
                    <ext:column name="level1"/>
                </ext:left>
                <ext:right alias="o">
                    <ext:column name="code"/>
                </ext:right>
                <ext:condition logicOperator="and" tableAlias="o" columnName="type" operator="eq" value="'О'"/>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="np" columnName="type" operator="eq" value="'НП'"/>
             </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-3146">
        <comment>CREATE search condition application_type_equal_constant_code</comment>
        <ext:createSearchCondition name="application_type_equal_constant_code">
            <ext:table name="application_type">
                <ext:column name="application_type_id" returning="true"/>
                <ext:column name="name" returning="true"/>
                <ext:column name="constant_code" searchType="equal" returning="true"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-4093">
        <comment>CREATE search condition factor_pesticides_contains_name</comment>
        <ext:createSearchCondition name="factor_pesticides_contains_name">
            <ext:table name="factor" alias="f">
                <ext:column name="factor_id" returning="true"/>
                <ext:column name="name" sorting="asc" searchType="contains" returning="true"/>
            </ext:table>
            <ext:where>
                <ext:condition tableAlias="f" columnName="factor_type" operator="eq" value="'Пестициди'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition MDTUDDM-7546">
        <comment>CREATE search condition laboratory_subject_id_equal</comment>
        <ext:createSearchCondition name="laboratory_equal_subject_id">
            <ext:table name="laboratory" alias="l">
                <ext:column name="laboratory_id" returning="true"/>
                <ext:column name="name" returning="true"/>
                <ext:column name="subject_id" searchType="equal"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="createSearchCondition MDTUDDM-7325">
        <comment>CREATE search condition last_laboratory_solution</comment>
        <ext:createSearchCondition name="last_laboratory_solution">
            <ext:cte name="cte_registration">
                <ext:table name="registration" alias="r">
                    <ext:column name="registration_id"/>
                    <ext:column name="laboratory_id"/>
                    <ext:column name="solution_date"/>
                    <ext:column name="ddm_created_at"/>
                </ext:table>
                <ext:table name="application_type" alias="a">
                    <ext:column name="application_type_id"/>
                </ext:table>
                <ext:table name="solution_type" alias="s">
                    <ext:column name="solution_type_id"/>
                </ext:table>
                <ext:join type="inner">
                    <ext:left alias="r">
                        <ext:column name="application_type_id"/>
                    </ext:left>
                    <ext:right alias="a">
                        <ext:column name="application_type_id"/>
                    </ext:right>
                </ext:join>
                <ext:join type="inner">
                    <ext:left alias="r">
                        <ext:column name="solution_type_id"/>
                    </ext:left>
                    <ext:right alias="s">
                        <ext:column name="solution_type_id"/>
                    </ext:right>
                </ext:join>
                <ext:where>
                    <ext:condition tableAlias="a" columnName="name" operator="eq" value="'Первинне визнання лабораторії атестованою'">
                        <ext:condition logicOperator="and" tableAlias="s" columnName="name" operator="eq" value="'Внести до інформаційного переліку'"/>
                    </ext:condition>
                    <ext:condition logicOperator="or" tableAlias="a" columnName="name" operator="eq" value="'Виключення з переліку атестованих'">
                        <ext:condition logicOperator="and" tableAlias="s" columnName="name" operator="eq" value="'Внести до інформаційного переліку'"/>
                    </ext:condition>
                </ext:where>
            </ext:cte>
            <ext:cte name="cte_max_solution_dates">
                <ext:table name="cte_registration">
                    <ext:column name="laboratory_id"/>
                    <ext:function name="max" columnName="solution_date" alias="solution_date"/>
                </ext:table>
            </ext:cte>
            <ext:cte name="cte_max_registrations">
                <ext:table name="cte_registration" alias="r">
                    <ext:column name="registration_id"/>
                    <ext:column name="laboratory_id"/>
                    <ext:column name="ddm_created_at"/>
                    <ext:column name="application_type_id"/>
                    <ext:column name="solution_type_id"/>
                </ext:table>
                <ext:table name="cte_max_solution_dates" alias="s">
                    <ext:column name="solution_date"/>
                </ext:table>
                <ext:join type="inner">
                    <ext:left alias="s">
                        <ext:column name="laboratory_id"/>
                        <ext:column name="solution_date"/>
                    </ext:left>
                    <ext:right alias="r">
                        <ext:column name="laboratory_id"/>
                        <ext:column name="solution_date"/>
                    </ext:right>
                </ext:join>
            </ext:cte>
            <ext:cte name="cte_max_created_dates">
                <ext:table name="cte_max_registrations">
                    <ext:column name="laboratory_id"/>
                    <ext:function name="max" columnName="ddm_created_at" alias="ddm_created_at"/>
                </ext:table>
            </ext:cte>
            <ext:table name="cte_max_registrations" alias="r">
                <ext:column name="registration_id"/>
                <ext:column name="application_type_id"/>
                <ext:column name="solution_type_id"/>
                <ext:column name="solution_date"/>
            </ext:table>
            <ext:table name="cte_max_created_dates" alias="md">
                <ext:column name="laboratory_id" searchType="equal"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="md">
                    <ext:column name="laboratory_id"/>
                    <ext:column name="ddm_created_at"/>
                </ext:left>
                <ext:right alias="r">
                    <ext:column name="laboratory_id"/>
                    <ext:column name="ddm_created_at"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="searchCondition laboratory_equal_subject_code_name">
        <comment>CREATE search condition laboratory_subject_code_name_equal</comment>
        <ext:createSearchCondition name="laboratory_equal_subject_code_name">
            <ext:table name="laboratory" alias="l">
                <ext:column name="laboratory_id"/>
                <ext:column name="name"/>
            </ext:table>
            <ext:table name="subject" alias="s">
                <ext:column name="subject_code" searchType="equal"/>
                <ext:column name="subject_type" searchType="equal"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="l">
                    <ext:column name="subject_id"/>
                </ext:left>
                <ext:right alias="s">
                    <ext:column name="subject_id"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

</databaseChangeLog>
