<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.2.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext xsd/dbchangelog-ext.xsd">

<!--		<property  name="dataLoadPath"  value="D:\PostgreSQL\csv\auto-lookup\"/>-->
<!--		<property  name="dataLoadPath"  value="C:\Work\MDTUDDM\git\certified-laboratories-registry-regulation\data-model\data-load\auto-lookup\"/>-->
	<property  name="dataLoadPath"  value="/tmp/data-load/auto-lookup/"/>

	<changeSet author="registry owner" id="load data to dictionaries">
		<sql dbms="postgresql" endDelimiter=";" splitStatements="true" stripComments="true">
			CALL p_load_table_from_csv('research','${dataLoadPath}01-Typy_doslidgen.csv', array['code','research_type'], array['research_type']);
			CALL p_load_table_from_csv('refusal_reason','${dataLoadPath}02-Prichiny_vidmov.csv', array['code','document_type','name','constant_code'], array['document_type','name','constant_code']);
			CALL p_load_table_from_csv(
			'koatuu'
			,'${dataLoadPath}03-KOATUU_simple.csv'
			, array['code','category','name']
			, array['code','category','name'
			,'level1::substring(code,1,2)||''00000000'''
			,'level2::substring(code,1,5)||''00000'''
			,'type::CASE WHEN code ~ ''[0-9]{2}0{8}'' AND code !~ ''(80|85)0{8}'' THEN ''О''
			WHEN code ~ ''[0-9]{2}2[0-9]{2}0{5}'' AND code !~ ''[0-9]{2}20{7}'' THEN ''Р''
			WHEN coalesce(category, ''Р'') != ''Р''
			OR code IN (SELECT DISTINCT substring(code,1,5)||''00000'' FROM koatuu_csv k2 WHERE category = ''Р'') AND category IS NULL
			OR code ~ ''(80|85)0{8}'' THEN ''НП''
			ELSE NULL END']
			);
			CALL p_load_table_from_csv('ownership','${dataLoadPath}04-Klasifikazia_form_vlasnosti_210319.csv', array['code','name']);
			CALL p_load_table_from_csv('kopfg','${dataLoadPath}05-Kopfg.csv', array['code','name']);
			CALL p_load_table_from_csv('solution_type','${dataLoadPath}06_Typy_rishen_210319.csv', array['id','name','constant_code'], array['name','constant_code']);
			CALL p_load_table_from_csv('application_type','${dataLoadPath}07-Typy_zayav.csv', array['id','name','constant_code'], array['name','constant_code']);
			CALL p_load_table_from_csv('staff_status','${dataLoadPath}08-Status_spivrobitnika.csv', array['code','name','constant_code'], array['name','constant_code']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}09-Fizichni_factory.csv', array['curr_name','name','notes'], array['name','factor_type::''Фізичний''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}09-Trudovogo_procesu_factory.csv', array['curr_name','name','notes'], array['name','factor_type::''Трудового процесу''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}09-Himichny_Factory_HOST_210319.csv', array['code','name','notes'], array['code','name','factor_type::''Хімічний: ГОСТ''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}factory_himichni_gigienichny_210407.csv', array['code','name','col3','col4','col5','col6','col7','col8'], array['code','name','factor_type::''Хімічний: Гігієнічні регламенти''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}Himichni_factory_OBRV_210622.csv', array['code','name','col3','col4','notes'], array['code','name','factor_type::''Хімічний: ОБРВ''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}faktory_himichni_dovilni_210406.csv', array['code','name','notes'], array['code','name','notes','factor_type::''Хімічний: довільні''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}Biologichni factory(reglament).csv', array['code','name','col3','col4','col5','col6','notes'], array['code','name','factor_type::''Біологічний''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}Biologichni factory(poperedniy)_210324.csv', array['code','name'], array['code','name','factor_type::''Біологічний: попередній''']);
			CALL p_load_table_from_csv('factor','${dataLoadPath}Pesticidu_210324.csv', array['code','name'], array['code','name','factor_type::''Пестициди''']);

			CALL p_load_table_from_csv('subject','${dataLoadPath}EDRPOU_Uniq_210622.csv', array['subject_code','subject_name','subject_type']);

			CALL p_load_table_from_csv('laboratory','${dataLoadPath}Laboratory_210622.csv'
			,array['uuid','name','koatuu_id','col4','col5','address','phone_number','head_name','edrpou','ownership_id','kopfg_id','accreditation_flag','accreditation_end_date','notes','infolist_inclusion_flag','infolist_inclusion_date','deny_infolist_inclusion_flag','infolist_exclusion_flag','infolist_exclusion_date']
			,array['name','address','phone_number','head_name','edrpou','accreditation_flag','accreditation_end_date','notes'
			,'koatuu_id::ref(lookup_col:koatuu_id,ref_table:koatuu,ref_col:code,ref_id:koatuu_id)'
			,'ownership_id::ref(lookup_col:ownership_id,ref_table:ownership,ref_col:name,ref_id:ownership_id)'
			,'kopfg_id::ref(lookup_col:kopfg_id,ref_table:kopfg,ref_col:name,ref_id:kopfg_id)'
			,'subject_id::ref(lookup_col:edrpou,ref_table:subject,ref_col:subject_code,ref_id:subject_id)'
			]
			);

			CALL p_load_table_from_csv('staff','${dataLoadPath}Staff_210622.csv'
			,array['uuid','colX','laboratory_id','staff_status_id','researches','full_name','hygienist_flag','full_time_flag','salary','fixed_term_contract_flag','contract_end_date','specialization_date','specialization_end_date','dismissal_flag','dismissal_date']
			,array['laboratory_id'
			,'staff_status_id::ref(lookup_col:staff_status_id,ref_table:staff_status,ref_col:name,ref_id:staff_status_id)'
			,'researches::ref_array(lookup_col:researches,ref_table:research,ref_col:research_type,ref_id:research_id)'
			,'full_name','hygienist_flag','full_time_flag','salary','fixed_term_contract_flag','contract_end_date','specialization_date','specialization_end_date','dismissal_date']
			);

			CALL p_load_table_from_csv('registration','${dataLoadPath}Registration_210622.csv'
			,array['uuid','registration_no','created_date','registration_source','application_type_id','accepted_by','laboratory_id','colX','refusal_reasons','health_ministry_letter_number','health_ministry_letter_date','solution_type_id','colY','solution_date','exclusion_order_no','exclusion_order_date','letter_no','letter_date','received_by','certified_by','notes','factors_fisichny','factors_trud_proc','factors_Host_dovilny','factors_gigien',
			'col1','col2','col3','col4','col5','col6','col7','col8','col9','col10','col11','col12','col13']
			,array['registration_no','created_date','registration_source','accepted_by'
			,'laboratory_id','health_ministry_letter_number','health_ministry_letter_date','solution_date','exclusion_order_no','exclusion_order_date','letter_no','letter_date','received_by','certified_by','notes'
			,'application_type_id::ref(lookup_col:application_type_id,ref_table:application_type,ref_col:name,ref_id:application_type_id)'
			,'solution_type_id::ref(lookup_col:solution_type_id,ref_table:solution_type,ref_col:name,ref_id:solution_type_id)'
			,'factors::ref_array(lookup_col:factors_fisichny,ref_table:factors_fiz_v,ref_col:name,ref_id:factor_id,delim:#)'
			,'factors::ref_array(lookup_col:factors_trud_proc,ref_table:factors_labor_v,ref_col:name,ref_id:factor_id,delim:#)'
			,'factors::ref_array(lookup_col:factors_Host_dovilny,ref_table:factors_chem_host_dovil_v,ref_col:name,ref_id:factor_id,delim:#)'
			,'factors::ref_array(lookup_col:factors_gigien,ref_table:factors_chemhihien_v,ref_col:name,ref_id:factor_id,delim:#)'
			,'refusal_reasons::''{}'''
			]
			);


		</sql>
	</changeSet>

	<changeSet author="registry owner" id="load data to koatuu table">
		<sql>SELECT f_row_insert('koatuu', ('curr_user=>"admin",source_system=>"System 1",source_application=>"Application 1",source_process=>"Business process 1",process_id=>"1204"')::hstore,($$code=>"0200000000",category=>NULL,name=>"М.КИЇВ",type=>О,level1=>8000000000,level2=>8000000000$$)::hstore)</sql>
		<sql>SELECT f_row_insert('koatuu', ('curr_user=>"admin",source_system=>"System 1",source_application=>"Application 1",source_process=>"Business process 1",process_id=>"1204"')::hstore,($$code=>"9900000000",category=>NULL,name=>"М.СЕВАСТОПОЛЬ",type=>О,level1=>8500000000,level2=>8500000000$$)::hstore)</sql>
	</changeSet>

</databaseChangeLog>
