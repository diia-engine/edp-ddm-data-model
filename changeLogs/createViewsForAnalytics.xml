<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.2.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext xsd/dbchangelog-ext.xsd">

    <changeSet author="registry owner" id="create report_registration_factor view">
        <ext:createSearchCondition name="report_registration_factor">
            <ext:table name="registration_factor_rel_v" alias="rf">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="factor_id" returning="false"/>
            </ext:table>
            <ext:table name="factor" alias="fct">
                <ext:column name="name" returning="false"/>
                <ext:column name="factor_type" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="rf">
                    <ext:column name="factor_id"/>
                </ext:left>
                <ext:right alias="fct">
                    <ext:column name="factor_id"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_fiz_factors view">
        <ext:createSearchCondition name="report_fiz_factors">
            <ext:table name="registration_factor_rel_v" alias="rf">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="factor_id" returning="false"/>
            </ext:table>
            <ext:table name="factor" alias="fct">
                <ext:column name="name" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="rf">
                    <ext:column name="factor_id"/>
                </ext:left>
                <ext:right alias="fct">
                    <ext:column name="factor_id"/>
                </ext:right>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="fct" columnName="factor_type" operator="eq" value="'Фізичний'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_bio_factors view">
        <ext:createSearchCondition name="report_bio_factors">
            <ext:table name="registration_factor_rel_v" alias="rf">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="factor_id" returning="false"/>
            </ext:table>
            <ext:table name="factor" alias="fct">
                <ext:column name="name" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="rf">
                    <ext:column name="factor_id"/>
                </ext:left>
                <ext:right alias="fct">
                    <ext:column name="factor_id"/>
                </ext:right>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="fct" columnName="factor_type" operator="like" value="'Біологічний%'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_him_factors view">
        <ext:createSearchCondition name="report_him_factors">
            <ext:table name="registration_factor_rel_v" alias="rf">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="factor_id" returning="false"/>
            </ext:table>
            <ext:table name="factor" alias="fct">
                <ext:column name="name" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="rf">
                    <ext:column name="factor_id"/>
                </ext:left>
                <ext:right alias="fct">
                    <ext:column name="factor_id"/>
                </ext:right>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="fct" columnName="factor_type" operator="like" value="'Хімічний%'">
                    <ext:condition logicOperator="or" tableAlias="fct" columnName="factor_type" operator="eq" value="'Пестициди'"></ext:condition>
                </ext:condition>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_trud_factors view">
        <ext:createSearchCondition name="report_trud_factors">
            <ext:table name="registration_factor_rel_v" alias="rf">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="factor_id" returning="false"/>
            </ext:table>
            <ext:table name="factor" alias="fct">
                <ext:column name="name" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="rf">
                    <ext:column name="factor_id"/>
                </ext:left>
                <ext:right alias="fct">
                    <ext:column name="factor_id"/>
                </ext:right>
            </ext:join>
            <ext:where>
                <ext:condition tableAlias="fct" columnName="factor_type" operator="eq" value="'Трудового процесу'"/>
            </ext:where>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_laboratory view">
        <ext:createSearchCondition name="report_laboratory">
            <ext:table name="laboratory" alias="l">
                <ext:column name="laboratory_id" returning="false"/>
                <ext:column name="name" returning="false"/>
                <ext:column name="address" returning="false"/>
                <ext:column name="phone_number" returning="false"/>
                <ext:column name="edrpou" returning="false"/>
                <ext:column name="accreditation_flag" returning="false"/>
                <ext:column name="accreditation_end_date" returning="false"/>
                <ext:column name="koatuu_id" returning="false"/>
                <ext:column name="kopfg_id" returning="false"/>
                <ext:column name="ownership_id" returning="false"/>
            </ext:table>
            <ext:table name="koatuu" alias="k">
                <ext:column name="name" alias="town" returning="false"/>
                <ext:column name="level1" alias="obl_code" returning="false"/>
            </ext:table>
            <ext:table name="koatuu" alias="ko">
                <ext:column name="name" alias="region" returning="false"/>
            </ext:table>
            <ext:table name="kopfg" alias="kp">
                <ext:column name="name" alias="management" returning="false"/>
            </ext:table>
            <ext:table name="ownership" alias="o">
                <ext:column name="name" alias="ownership" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="l">
                    <ext:column name="koatuu_id"/>
                </ext:left>
                <ext:right alias="k">
                    <ext:column name="koatuu_id"/>
                </ext:right>
            </ext:join>
            <ext:join type="left">
                <ext:left alias="ko">
                    <ext:column name="code"/>
                </ext:left>
                <ext:right alias="k">
                    <ext:column name="level1"/>
                </ext:right>
            </ext:join>
            <ext:join type="inner">
                <ext:left alias="l">
                    <ext:column name="kopfg_id"/>
                </ext:left>
                <ext:right alias="kp">
                    <ext:column name="kopfg_id"/>
                </ext:right>
            </ext:join>
            <ext:join type="inner">
                <ext:left alias="l">
                    <ext:column name="ownership_id"/>
                </ext:left>
                <ext:right alias="o">
                    <ext:column name="ownership_id"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_staff_research view">
        <ext:createSearchCondition name="report_staff_research">
            <ext:table name="staff_research_rel_v" alias="sr">
                <ext:column name="staff_id" returning="false"/>
                <ext:column name="research_id" returning="false"/>
            </ext:table>
            <ext:table name="research" alias="r">
                <ext:column name="research_type" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="sr">
                    <ext:column name="research_id"/>
                </ext:left>
                <ext:right alias="r">
                    <ext:column name="research_id"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_registration view">
        <ext:createSearchCondition name="report_registration">
            <ext:table name="registration" alias="r">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="laboratory_id" returning="false"/>
                <ext:column name="created_date" returning="false"/>
                <ext:column name="registration_source" returning="false"/>
                <ext:column name="accepted_by" returning="false"/>
                <ext:column name="solution_date" returning="false"/>
                <ext:column name="health_ministry_letter_number" returning="false"/>
                <ext:column name="health_ministry_letter_date" returning="false"/>
                <ext:column name="exclusion_order_no" returning="false"/>
                <ext:column name="exclusion_order_date" returning="false"/>
                <ext:column name="letter_no" returning="false"/>
                <ext:column name="received_by" returning="false"/>
                <ext:column name="certified_by" returning="false"/>
                <ext:column name="application_type_id" returning="false"/>
                <ext:column name="solution_type_id" returning="false"/>
            </ext:table>
            <ext:table name="application_type" alias="a">
                <ext:column name="name" alias="application_type" returning="false"/>
            </ext:table>
            <ext:table name="solution_type" alias="s">
                <ext:column name="name" alias="solution_type" returning="false"/>
            </ext:table>
            <ext:join type="inner">
                <ext:left alias="a">
                    <ext:column name="application_type_id"/>
                </ext:left>
                <ext:right alias="r">
                    <ext:column name="application_type_id"/>
                </ext:right>
            </ext:join>
            <ext:join type="left">
                <ext:left alias="s">
                    <ext:column name="solution_type_id"/>
                </ext:left>
                <ext:right alias="r">
                    <ext:column name="solution_type_id"/>
                </ext:right>
            </ext:join>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_staff_count view">
        <ext:createSearchCondition name="report_staff_count">
            <ext:table name="staff">
                <ext:column name="laboratory_id" returning="false"/>
                <ext:function name="count" columnName="case when hygienist_flag then 1 else null end" alias="hygienist_count"/>
                <ext:function name="count" columnName="case when hygienist_flag then null else 1 end" alias="laborant_count"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_staff view">
        <ext:createSearchCondition name="report_staff">
            <ext:table name="staff">
                <ext:column name="staff_id" returning="false"/>
                <ext:column name="laboratory_id" returning="false"/>
                <ext:column name="full_name" returning="false"/>
                <ext:column name="hygienist_flag" returning="false"/>
                <ext:column name="full_time_flag" returning="false"/>
                <ext:column name="salary" returning="false"/>
                <ext:column name="fixed_term_contract_flag" returning="false"/>
                <ext:column name="contract_end_date" returning="false"/>
                <ext:column name="specialization_date" returning="false"/>
                <ext:column name="specialization_end_date" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_application_type view">
        <ext:createSearchCondition name="report_application_type">
            <ext:table name="application_type">
                <ext:column name="application_type_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_kopfg view">
        <ext:createSearchCondition name="report_kopfg">
            <ext:table name="kopfg">
                <ext:column name="kopfg_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_koatuu view">
        <ext:createSearchCondition name="report_koatuu">
            <ext:table name="koatuu">
                <ext:column name="koatuu_id" returning="false"/>
                <ext:column name="code" returning="false"/>
                <ext:column name="name" returning="false"/>
                <ext:column name="type" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_ownership view">
        <ext:createSearchCondition name="report_ownership">
            <ext:table name="ownership">
                <ext:column name="ownership_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_solution_type view">
        <ext:createSearchCondition name="report_solution_type">
            <ext:table name="solution_type">
                <ext:column name="solution_type_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_research view">
        <ext:createSearchCondition name="report_research">
            <ext:table name="research">
                <ext:column name="research_id" returning="false"/>
                <ext:column name="research_type" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_solution_type view">
        <ext:createSearchCondition name="report_solution_type">
            <ext:table name="solution_type">
                <ext:column name="solution_type_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_application_type view">
        <ext:createSearchCondition name="report_application_type">
            <ext:table name="application_type">
                <ext:column name="application_type_id" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_factor view">
        <ext:createSearchCondition name="report_factor">
            <ext:table name="factor">
                <ext:column name="factor_id" returning="false"/>
                <ext:column name="factor_type" returning="false"/>
                <ext:column name="name" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create report_simple_registration view">
        <ext:createSearchCondition name="report_simple_registration">
            <ext:table name="registration">
                <ext:column name="registration_id" returning="false"/>
                <ext:column name="laboratory_id" returning="false"/>
                <ext:column name="created_date" returning="false"/>
                <ext:column name="registration_source" returning="false"/>
                <ext:column name="accepted_by" returning="false"/>
                <ext:column name="solution_date" returning="false"/>
                <ext:column name="health_ministry_letter_number" returning="false"/>
                <ext:column name="health_ministry_letter_date" returning="false"/>
                <ext:column name="exclusion_order_no" returning="false"/>
                <ext:column name="exclusion_order_date" returning="false"/>
                <ext:column name="letter_no" returning="false"/>
                <ext:column name="received_by" returning="false"/>
                <ext:column name="certified_by" returning="false"/>
                <ext:column name="application_type_id" returning="false"/>
                <ext:column name="solution_type_id" returning="false"/>
                <ext:column name="factors" returning="false"/>
            </ext:table>
        </ext:createSearchCondition>
    </changeSet>

    <changeSet author="registry owner" id="create indexes">
        <createIndex tableName="laboratory" indexName="idx_laboratory__kopfg_id">
            <column name="kopfg_id"/>
        </createIndex>
        <createIndex tableName="laboratory" indexName="idx_laboratory__ownership_id">
            <column name="ownership_id"/>
        </createIndex>
        <createIndex tableName="laboratory" indexName="idx_laboratory__lower_name">
            <column name="lower(name) text_pattern_ops"/>
        </createIndex>

        <createIndex tableName="kopfg" indexName="idx_kopfg__name">
            <column name="name"/>
        </createIndex>

        <createIndex tableName="ownership" indexName="idx_ownership__name">
            <column name="name"/>
        </createIndex>

        <createIndex tableName="registration" indexName="idx_registration__laboratory_id">
            <column name="laboratory_id"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__application_type_id">
            <column name="application_type_id"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__solution_type_id">
            <column name="solution_type_id"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__solution_date">
            <column name="solution_date" descending="true"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__created_date">
            <column name="created_date"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__ddm_created_at">
            <column name="ddm_created_at"/>
        </createIndex>
        <createIndex tableName="registration" indexName="idx_registration__registration_source">
            <column name="registration_source"/>
        </createIndex>

        <createIndex tableName="koatuu" indexName="idx_koatuu__code">
            <column name="code"/>
        </createIndex>

        <createIndex tableName="koatuu" indexName="idx_koatuu__level1">
            <column name="level1"/>
        </createIndex>

        <createIndex tableName="staff" indexName="idx_staff__hygienist_flag">
            <column name="hygienist_flag"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__lower_full_name">
            <column name="lower(full_name) text_pattern_ops"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__full_time_flag">
            <column name="full_time_flag"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__fixed_term_contract_flag">
            <column name="fixed_term_contract_flag"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__contract_end_date">
            <column name="contract_end_date"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__specialization_date">
            <column name="specialization_date"/>
        </createIndex>
        <createIndex tableName="staff" indexName="idx_staff__specialization_end_date">
            <column name="specialization_end_date"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
